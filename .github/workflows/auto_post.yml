name: Auto Post Threads

on:
  schedule:
    # æ¯å¤©å°åŒ— 01,04,07,10,13,16,19,22 é»
    - cron: '0 17 * * *'
    - cron: '0 20 * * *'
    - cron: '0 23 * * *'
    - cron: '0 2  * * *'
    - cron: '0 5  * * *'
    - cron: '0 8  * * *'
    - cron: '0 11 * * *'
    - cron: '0 14 * * *'
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # â‘  å®‰è£ Python + å…§å»º pip cache
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: pip                       # ğŸ‰ é€™ä¸€è¡ŒæŠŠ pip ä¸‹è¼‰å¥½çš„ wheel æ‰“åŒ…é€² cache
          cache-dependency-path: requirements.txt

      # â‘¡ å†æŠŠå·¨å¤§æ¨¡å‹æª”ä¹Ÿ cache èµ·ä¾†
      - name: Cache HF & Torch models
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/torch
            ~/.cache/huggingface
            ~/.cache/sentence_transformers
          key: ${{ runner.os }}-models-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-models-

      # â‘¢ å®‰è£ requirementsï¼ˆå› ç‚ºæœ‰ wheel cacheï¼Œé€™ä¸€æ­¥åªåšã€Œè§£å£“ï¼‹å®‰è£ã€ï¼Œ10 ç§’å…§æå®šï¼‰
      - name: Install dependencies
        run: |
          pip install -r requirements.txt --progress-bar off

      # â‘£ åŒæ­¥ CSV â†’ SQLite
      - name: Sync CSV â†’ SQLite
        run: python3 manage_posts.py

      # â‘¤ ç”Ÿæˆä¸¦ç™¼å¸ƒè²¼æ–‡
      - name: Generate & publish post via Threads API
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          THREADS_USER_ID:  ${{ secrets.THREADS_USER_ID }}
          LONG_LIVED_TOKEN: ${{ secrets.LONG_LIVED_TOKEN }}
        run: python3 threads_auto_poster.py
